# Hardware definition file for processing by chibios_pins.py
# SkyRukh Surge H7 FC board with H743 MCU, BMI088, Barometer,
# ICM20602, TF-card, FRAM, and OSD

# MCU class and specific type
MCU STM32H7 STM32H743xx

# crystal frequency
OSCILLATOR_HZ 16000000

# board ID.
APJ_BOARD_ID AP_HW_SkyRukh_Surge_H7

# flash size
FLASH_SIZE_KB 2048

# ChibiOS system timer
define STM32_ST_USE_TIMER 2

# bootloader takes first sector
FLASH_RESERVE_START_KB 128

# I2C Buses

# I2C2, GPS connector
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# I2C2, external
PF14 I2C4_SCL I2C4
PF15 I2C4_SDA I2C4

# order of I2C buses
I2C_ORDER I2C2 I2C4

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART2 USART6 USART3 UART7 UART4 UART5 UART8

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# pins for SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# SBUS
PD14 SBUS_INV OUTPUT HIGH

# RC input
PA10 TIM1_CH3 TIM1 RCININT PULLDOWN LOW

# UARTs

PD5     USART2_TX USART2
PD6     USART2_RX USART2
PD3	    USART2_CTS USART2
PD4	    USART2_RTS USART2

PD8	    USART3_TX USART3
PD9	    USART3_RX USART3

PD1     UART4_TX UART4 NODMA
PD0     UART4_RX UART4 NODMA

PB13	UART5_TX UART5
PB12	UART5_RX UART5

PG14    USART6_TX  USART6
PG9     USART6_RX  USART6
PG15	USART6_CTS USART6
PG12	USART6_RTS USART6

PE8     UART7_TX UART7 
PF6     UART7_RX UART7
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_None

PE0     UART8_RX UART8
PE1     UART8_TX UART8

# drdy pins
PB3 DRDY2_ICM20602 INPUT
PE4 DRDY3_BMI088_GYRO1	INPUT
PI8 DRDY3_BMI088_ACC1	INPUT
PI7 DRDY6_BMI088_GYRO2	INPUT
PF2 DRDY2_BMI088_ACC2	INPUT

# ADC inputs
define HAL_USE_ADC TRUE
define STM32_ADC_USE_ADC1 TRUE

# ADC pins
PA0     BATT_VOLT_SENS ADC1      SCALE(1)
PA1     BATT_CURR_SENS ADC1      SCALE(2)

# Default battery setup
define HAL_BATT_VOLT_PIN            16
define HAL_BATT_CURR_PIN            17
define HAL_BATT_MONITOR_DEFAULT     4
define HAL_BATT_VOLT_SCALE          7.39
define HAL_BATT_CURR_SCALE          40.0

# Motors
PH12 TIM5_CH3 TIM5 PWM(1) GPIO(50)
PH11 TIM5_CH2 TIM5 PWM(2) GPIO(51) BIDIR
PH10 TIM5_CH1 TIM5 PWM(3) GPIO(52)
PD13 TIM4_CH2 TIM4 PWM(4) GPIO(53) BIDIR

PI5  TIM8_CH1 TIM8 PWM(5) GPIO(54)
PB6  TIM4_CH1 TIM4 PWM(6) GPIO(55)
PI6  TIM8_CH2 TIM8 PWM(7) GPIO(56)
PD15 TIM4_CH4 TIM4 PWM(8) GPIO(57)

# SPI Pins and CS
PG10    MAX7456_CS	CS
PG11    SPI1_SCK        SPI1
PA6     SPI1_MISO       SPI1
PD7     SPI1_MOSI       SPI1

PH15    FRAM_CS1	CS
PI1     SPI2_SCK        SPI2
PI2     SPI2_MISO       SPI2
PI3     SPI2_MOSI       SPI2

PF0     BMI088_G_CS	CS
PC13	BMI088_A_CS	CS
PE2     SPI4_SCK        SPI4
PE5	    SPI4_MISO       SPI4
PE6     SPI4_MOSI       SPI4

PF10	DPS310_CS1	    CS
PF7     SPI5_SCK        SPI5
PF8     SPI5_MISO       SPI5
PF9     SPI5_MOSI       SPI5

PB7	    ICM20602_CS	    CS SPEED_VERYLOW
PG13    SPI6_SCK        SPI6
PB4	    SPI6_MISO       SPI6
PB5	    SPI6_MOSI       SPI6

# SPI devices
SPIDEV bmi088_g         SPI4 DEVID1  BMI088_G_CS    MODE3  10*MHZ 10*MHZ
SPIDEV bmi088_a         SPI4 DEVID2  BMI088_A_CS    MODE3  10*MHZ 10*MHZ
SPIDEV icm20602		    SPI6 DEVID1  ICM20602_CS   MODE3  2*MHZ 8*MHZ
SPIDEV dps310     	    SPI5 DEVID2  DPS310_CS1    MODE3  5*MHZ 5*MHZ
SPIDEV ramtron          SPI2 DEVID1  FRAM_CS1      MODE3  8*MHZ  8*MHZ
SPIDEV osd              SPI1 DEVID1  MAX7456_CS	   MODE0 10*MHZ 10*MHZ

# IMU Setup
IMU BMI088              SPI:bmi088_a SPI:bmi088_g       ROTATION_PITCH_180
IMU Invensense          SPI:icm20602                	ROTATION_YAW_90

# Barometer Setup
BARO DPS310 SPI:dps310

# setup for OSD
define OSD_ENABLED 1
define HAL_OSD_TYPE_DEFAULT 1
ROMFS_WILDCARD libraries/AP_OSD/fonts/font*.bin

# SD Card
PC8	    SDMMC1_D0       SDMMC1
PC9	    SDMMC1_D1       SDMMC1
PC10	SDMMC1_D2       SDMMC1
PC11	SDMMC1_D3       SDMMC1
PC12	SDMMC1_CK       SDMMC1
PD2	    SDMMC1_CMD      SDMMC1
PB2 	SDCARD_DETECT 	INPUT

# CAN bus
PH13 CAN1_TX CAN1
PH14 CAN1_RX CAN1

# control for silent (no output) for CAN
PH2 GPIO_CAN1_SILENT OUTPUT PUSHPULL SPEED_LOW LOW GPIO(70)

# LED
define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1
PA7 LED_R1 OUTPUT PUSH_PULL LOW GPIO(10)
PB0 LED_G1 OUTPUT PUSH_PULL LOW GPIO(11)
PB1 LED_B1 OUTPUT PUSH_PULL LOW GPIO(12)

define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 10
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 11
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 12
define AP_NOTIFY_GPIO_LED_INVERTED

# CAN 
define HAL_CAN_ENABLED      1
define HAL_CAN_NUM_DRIVERS 1

# enable RAMTROM parameter storage
define HAL_STORAGE_SIZE 32768
define HAL_WITH_RAMTRON 1
define STORAGE_FLASH_PAGE 14

# SD Card
define HAL_OS_FATFS_IO 1

# DMA configuration for PWM timers
DMA_NOSHARE TIM5_UP TIM4_UP TIM1_UP
DMA_PRIORITY TIM5_UP TIM4_UP TIM1_UP TIM3_UP

define ALLOW_ARM_NO_COMPASS
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define HAL_I2C_INTERNAL_MASK 0
define HAL_COMPASS_AUTO_ROT_DEFAULT 2
define HAL_DEFAULT_INS_FAST_SAMPLE 5

# build ABIN for flash-from-bootloader support:
env BUILD_ABIN True

include ../include/minimize_fpv_osd.inc