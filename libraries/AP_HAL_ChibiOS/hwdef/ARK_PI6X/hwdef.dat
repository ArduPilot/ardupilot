# Processed by chibios_hwdef.py

include common.inc

# ChibiOS system timer
STM32_ST_USE_TIMER 2

# Bootloader takes first sector
FLASH_RESERVE_START_KB 128

# Use last 2 pages for flash storage
# H743 has 16 pages of 128k each
define HAL_STORAGE_SIZE 32768
STORAGE_FLASH_PAGE 14

# to be compatible with the px4 bootloader we need
# to use a different RAM_MAP
env USE_ALT_RAM_MAP 1

# default to all pins low to avoid ESD issues
DEFAULTGPIO OUTPUT LOW PULLDOWN

# order of UARTs (and USB)
# USB, Telem1, Telem2, GPS1, ESC Telem, RC
SERIAL_ORDER OTG1 UART7 UART5 USART1 UART4 USART6

# Debug console
STDOUT_SERIAL SD3
STDOUT_BAUDRATE 57600

# ESC Telemetry
PH13 UART4_TX UART4 NODMA
PH14 UART4_RX UART4 NODMA
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_ESCTelemetry
define DEFAULT_SERIAL4_BAUD 115

# RC
PC6 USART6_TX USART6
PC7 USART6_RX USART6
define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_RCIN

# ADC
PA0  SCALED1_V3V3 ADC1 SCALE(2)
PA4  SCALED2_V3V3 ADC1 SCALE(2)
PB0  SCALED3_V3V3 ADC1 SCALE(2)
PF12 SCALED4_V3V3 ADC1 SCALE(2)
PB1  VDD_5V_SENS  ADC1 SCALE(2)

# SPI1 - IIM42652
PA5 SPI1_SCK SPI1
PB5 SPI1_MOSI SPI1
PG9 SPI1_MISO SPI1
PI9 IMU1_CS CS
PF2 IMU1_DRDY INPUT

# SPI2 - ICM42688
PI1 SPI2_SCK SPI2
PI2 SPI2_MISO SPI2
PI3 SPI2_MOSI SPI2
PH5 IMU2_CS CS
PA10 IMU2_DRDY INPUT

# PWM output pins
PI0  TIM5_CH4 TIM5 PWM(1) GPIO(50) BIDIR
PH12 TIM5_CH3 TIM5 PWM(2) GPIO(51)
PH11 TIM5_CH2 TIM5 PWM(3) GPIO(52) BIDIR
PH10 TIM5_CH1 TIM5 PWM(4) GPIO(53)
PD13 TIM4_CH2 TIM4 PWM(5) GPIO(54)
PD14 TIM4_CH3 TIM4 PWM(6) GPIO(55)
# we need to disable DMA on the last 2 FMU channels
# as timer 12 doesn't have a TIMn_UP DMA option
PH6 TIM12_CH1 TIM12 PWM(7) GPIO(56) NODMA
PH9 TIM12_CH2 TIM12 PWM(8) GPIO(57) NODMA

# GPIOs
PC0 NFC_GPIO INPUT GPIO(60)

# CAN bus
PD0 CAN1_RX CAN1
PD1 CAN1_TX CAN1

# I2C1 external (GPS1 connector)
PB9 I2C1_SDA I2C1
PB8 I2C1_SCL I2C1

# I2C3 internal (INA226 power monitor)
PA8 I2C3_SCL I2C3
PH8 I2C3_SDA I2C3

# I2C4 internal (IIS2MDC mag and BMP390 baro)
PF14 I2C4_SCL I2C4
PF15 I2C4_SDA I2C4

# Order of I2C buses
I2C_ORDER I2C1 I2C3 I2C4
define HAL_I2C_INTERNAL_MASK 6

# Barometer on I2C4
BARO BMP388 I2C:2:0x76

# Compass on I2C4
COMPASS IIS2MDC I2C:2:0x1E false ROTATION_YAW_180
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define AP_COMPASS_IIS2MDC_ENABLED 1

# IMU heater
PB10 HEATER_EN OUTPUT LOW GPIO(80)
define HAL_HEATER_GPIO_PIN 80
define HAL_HAVE_IMU_HEATER 1
define HAL_IMU_TEMP_DEFAULT 45
define HAL_IMUHEAT_P_DEFAULT 50
define HAL_IMUHEAT_I_DEFAULT 0.07

# Power enable pins
PC13 VDD_3V3_SD_CARD_EN OUTPUT HIGH
PI11 VDD_3V3_SENSORS1_EN OUTPUT HIGH

# Power sensing
PF13 VDD_5V_HIPOWER_nOC INPUT PULLUP

PG1 VDD_BRICK_nVALID INPUT PULLUP
PG2 VDD_BRICK2_nVALID INPUT PULLUP
PG3 VDD_BRICK3_nVALID INPUT PULLUP

# LEDs
PE3 LED_RED OUTPUT OPENDRAIN GPIO(90) HIGH
PE4 LED_GREEN OUTPUT OPENDRAIN GPIO(91) HIGH
PE5 LED_BLUE OUTPUT OPENDRAIN GPIO(92) HIGH
define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 90
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 91
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 92
define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1

# ID pins
PG0 HW_VER_REV_DRIVE OUTPUT LOW
PH4 HW_REV_SENS ADC3 SCALE(1)

# PWM output for buzzer
PF9 TIM14_CH1 TIM14 GPIO(77) ALARM

# IMUs
SPIDEV icm42688_1  SPI1 DEVID1  IMU1_CS MODE3  2*MHZ  16*MHZ
SPIDEV icm42688_2  SPI2 DEVID1  IMU2_CS MODE3  2*MHZ  16*MHZ

IMU Invensensev3 SPI:icm42688_1 ROTATION_ROLL_180_YAW_135
IMU Invensensev3 SPI:icm42688_2 ROTATION_ROLL_180_YAW_45
define HAL_DEFAULT_INS_FAST_SAMPLE 3

# INA226 battery monitor
define HAL_BATTMON_INA2XX_BUS 1
define HAL_BATTMON_INA2XX_ADDR 0
define HAL_BATT_MONITOR_DEFAULT 21

DMA_PRIORITY SDMMC* SPI*

# enable FAT filesystem support (needs a microSD defined via SDMMC)
define HAL_OS_FATFS_IO 1

# bootloader embedding / bootloader flashing not available
define AP_BOOTLOADER_FLASHING_ENABLED 0
