# hw definition file for processing by chibios_pins.py
# for J.A.R.W.I.S. H743

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID 2013

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 16000000

FLASH_SIZE_KB 2048
env OPTIMIZE -Os

# bootloader takes first sector
FLASH_RESERVE_START_KB 128

define HAL_STORAGE_SIZE 32768
STORAGE_FLASH_PAGE 14

# ChibiOS system timer
STM32_ST_USE_TIMER 12
define CH_CFG_ST_RESOLUTION 16

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# SPI1 for IMU1 (ICM42688P)
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
PA4 IMU1_CS CS

# two I2C bus
I2C_ORDER I2C2

# I2C1
PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# ADC
define HAL_USE_ADC FALSE
define STM32_ADC_USE_ADC1 FALSE
define HAL_DISABLE_ADC_DRIVER TRUE

# Disable un-needed hardware drivers
#define AP_BATTERY_BACKEND_DEFAULT_ENABLED 0
define AP_BATTERY_ANALOG_ENABLED 0
#define AP_AIRSPEED_ENABLED 0
#define AP_BEACON_ENABLED 0
#define AP_OPTICALFLOW_ENABLED 0

define HAL_BARO_ALLOW_INIT_NO_BARO
define AP_BARO_DUMMY_ENABLED 1
define AP_BARO_ENABLED 0
#define HAL_EXTERNAL_AHRS_ENABLED 1

define AP_BATTERY_SYNTHETIC_CURRENT_ENABLED 0
define AP_BATTERY_FUELLEVEL_PWM_ENABLED 0
define AP_BATTERY_FUELFLOW_ENABLED 0

define HAL_BATT_MONITOR_DEFAULT 0

# LED
# green LED1 marked as B/E
# blue LED0 marked as ACT
PD8 LED1 OUTPUT LOW GPIO(90) # blue
PD9 LED2 OUTPUT LOW GPIO(91) # blue
define HAL_GPIO_A_LED_PIN 90
define HAL_GPIO_B_LED_PIN 91
define HAL_GPIO_LED_OFF 0
define HAL_GPIO_LED_ON  1

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1 USART2 USART3 UART4 

# USART1 (CM4)
PB15 USART1_RX USART1
PB14  USART1_TX USART1

# USART2
PD5 USART2_TX USART2
PD6 USART2_RX USART2

# USART3
PC11 USART3_RX USART3
PC10 USART3_TX USART3

# UART4
PB9 UART4_TX UART4
PB8 UART4_RX UART4

# CAN bus
PD0 CAN1_RX CAN1
PD1 CAN1_TX CAN1

PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2

# Motors
PA0   TIM5_CH1  TIM5  PWM(1)  GPIO(51)
PA1   TIM5_CH2  TIM5  PWM(2)  GPIO(52)
PA2   TIM5_CH3  TIM5  PWM(3)  GPIO(53)
PA3   TIM5_CH4  TIM5  PWM(4)  GPIO(54)
PE10  TIM1_CH2N TIM1  PWM(5)  GPIO(55)
PE11  TIM1_CH2  TIM1  PWM(6)  GPIO(56)
PE12  TIM1_CH3N TIM1  PWM(7)  GPIO(57)
PE13  TIM1_CH3  TIM1  PWM(8)  GPIO(58)
PD12  TIM4_CH1  TIM4  PWM(9)  GPIO(59)
PD13  TIM4_CH2  TIM4  PWM(10) GPIO(60)
PD14  TIM4_CH3  TIM4  PWM(11) GPIO(61)
PD15  TIM4_CH4  TIM4  PWM(12) GPIO(62)


# GPIOs
PB0  PINIO1 OUTPUT GPIO(71) HIGH
PB1  PINIO2 OUTPUT GPIO(72) HIGH
PB2  PINIO3 OUTPUT GPIO(73) HIGH
PE7  PINIO4 OUTPUT GPIO(74) HIGH
PE8  PINIO5 OUTPUT GPIO(75) HIGH

define RELAY1_PIN_DEFAULT 75
define RELAY2_PIN_DEFAULT 74
define RELAY3_PIN_DEFAULT 73
define RELAY4_PIN_DEFAULT 72
define RELAY5_PIN_DEFAULT 71

# spi devices
SPIDEV icm42688  SPI1 DEVID1 IMU1_CS      MODE3  2*MHZ 16*MHZ   # Clock is 100Mhz so highest clock <= 24Mhz is 100Mhz/8

# no built-in compass, but probe the i2c bus for all possible
# external compass types
define ALLOW_ARM_NO_COMPASS
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define HAL_I2C_INTERNAL_MASK 0
define HAL_COMPASS_AUTO_ROT_DEFAULT 2

# IMU
IMU Invensensev3 SPI:icm42688 ROTATION_YAW_180
define HAL_DEFAULT_INS_FAST_SAMPLE 1

# setup for OSD
define OSD_ENABLED 1
define HAL_OSD_TYPE_DEFAULT 0


#default parameters

define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_MAVLink2
define DEFAULT_SERIAL1_BAUD 921
define ARMING_CHECK 4128