# hw definition file for BOTWING-F405 hardware
# tested on the BOTWING-F405 board

# MCU class and specific type
MCU STM32F4xx STM32F405xx

# board ID for firmware load
APJ_BOARD_ID AP_HW_BOTWINGF405

# crystal frequency
OSCILLATOR_HZ 24000000

define STM32_ST_USE_TIMER 5

FLASH_RESERVE_START_KB 48
FLASH_SIZE_KB 1024

define HAL_STORAGE_SIZE 15360
STORAGE_FLASH_PAGE 1

# only one I2C bus
I2C_ORDER I2C1

# only one I2C bus (BARO - DPS310)
PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# SPI1 bus for GYRO (ICM42688P)
PA5 SPI1_SCK  SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
PA4 GYRO_CS   CS

# SPI2 for FLASH (W25Q128)
PB13 SPI2_SCK   SPI2
PB14 SPI2_MISO  SPI2
PB15 SPI2_MOSI  SPI2
PB12 FLASH_CS   CS

# SPI3 for OSD (AT7456E)
PC10 SPI3_SCK  SPI3
PC11 SPI3_MISO SPI3
PB5  SPI3_MOSI SPI3
PA15 OSD_CS    CS

# For debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD


# LEDs
define AP_NOTIFY_GPIO_LED_2_ENABLED 1
PC0 LED_A OUTPUT LOW GPIO(0)
PC5 LED_B OUTPUT LOW GPIO(1)

define HAL_GPIO_A_LED_PIN 0
define HAL_GPIO_B_LED_PIN 1

# Buzzer
PB0 BUZZER OUTPUT GPIO(80) LOW
define HAL_BUZZER_PIN 80

# --------- Power Control GPIOs and Relays ---------

# 9V Power Enable Control (PB1 → Relay1)
PB1 NINE_V_ENABLE OUTPUT GPIO(81) LOW
define RELAY1_PIN 81   # Relay1 controls 9V_ENABLE

# Secondary Power/Enable Control (PC13 → Relay2)
PC13 ENABLE_2 OUTPUT GPIO(82) LOW
define RELAY2_PIN 82   # Relay2 controls ENABLE_2

----------------------------------------------------

# Analog pins
PC1 BATT_VOLTAGE_SENS ADC1 SCALE(1)
PC2 RSSI_ADC_PIN      ADC1 SCALE(1)
PC3 BATT_CURRENT_SENS ADC1 SCALE(1)

define HAL_BATT_VOLT_PIN 11
define HAL_BATT_VOLT_SCALE 11.0

define BOARD_RSSI_ANA_PIN 12

define HAL_BATT_CURR_PIN 13
define HAL_BATT_CURR_SCALE 37.0

define HAL_BATT_MONITOR_DEFAULT 4

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1 USART2 USART3 UART4 UART5 USART6

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# --------- SBUS, PPM or ELRS Configurable Block ---------

# --- SBUS-INVERTED Mode ---
PB7 TIM4_CH2 TIM4 RCININT PULLDOWN LOW

# --- ELRS (CRSF) Mode ---
PB6  USART1_TX USART1  
PB7  USART1_RX USART1  ALT(1)

define DEFAULT_SERIAL1_PROTOCOL SerialProtocol_RCIN


# ----------------------------------------------------

# USART2 (ESC_TELEM)
PA2 USART2_TX USART2 NODMA
PA3 USART2_RX USART2 NODMA

define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_ESCTelemetry

# USART3 (DIGITAL OR ANALOG VIDEO)
PB10 USART3_TX USART3
PB11 USART3_RX USART3 NODMA

define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_MSP_DisplayPort


# UART4 (CAM)
PA0 UART4_TX UART4
PA1 UART4_RX UART4 NODMA

define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_SmartAudio


# UART5 
PC12 UART5_TX UART5
PD2  UART5_RX UART5

define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_None


# USART6 (GPS) 
PC6 USART6_TX USART6
PC7 USART6_RX USART6

define DEFAULT_SERIAL6_PROTOCOL SerialProtocol_GPS


# Motors
PA9  TIM1_CH2  TIM1  PWM(1)  GPIO(50)  BIDIR #M1
PA8  TIM1_CH1  TIM1  PWM(2)  GPIO(51)   #M2
PC9  TIM3_CH4  TIM3  PWM(3)  GPIO(52)  BIDIR #M3
PC8  TIM3_CH3  TIM3  PWM(4)  GPIO(53)   #M4

# RGB-LED-NeoPixel
PB3 TIM2_CH2 TIM2 PWM(5) GPIO(54)

DMA_PRIORITY TIM1* TIM3* S* 


# ICM42688P on SPI1
SPIDEV icm42688  SPI1 DEVID2 GYRO_CS      MODE3  1*MHZ  4*MHZ

# W25Q128 (FLASH) on SPI2
SPIDEV dataflash SPI2 DEVID1 FLASH_CS      MODE3  32*MHZ 32*MHZ

# OSD (AT7456E) on SPI3
SPIDEV osd SPI3 DEVID3 OSD_CS MODE0 10*MHZ 10*MHZ

define OSD_ENABLED 1
define HAL_OSD_TYPE_DEFAULT 1
ROMFS_WILDCARD libraries/AP_OSD/fonts/font0.bin

# one IMU
IMU Invensensev3 SPI:icm42688 ROTATION_PITCH_180

define HAL_DEFAULT_INS_FAST_SAMPLE 1

# one baro
BARO DPS310 I2C:0:0x76

#CAD1 logic low, CAD0 logic low (b00001100) [internal mag]
COMPASS AK8963 I2C:0:0x0c ROTATION_NONE

define HAL_COMPASS_AK8963_ENABLED 1

define AP_BARO_BACKEND_DEFAULT_ENABLED 0
define AP_BARO_DPS280_ENABLED 1


# no built-in compass, but probe the i2c bus for all possible
# external compass types
define ALLOW_ARM_NO_COMPASS
define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define HAL_I2C_INTERNAL_MASK 0
define HAL_COMPASS_AUTO_ROT_DEFAULT 2
define HAL_I2C_ENABLED


# minimal drivers to reduce flash usage
include ../include/minimize_fpv_osd.inc

undef AP_CAMERA_MOUNT_ENABLED
undef HAL_MOUNT_ENABLED
undef HAL_MOUNT_SERVO_ENABLED

define AP_CAMERA_MOUNT_ENABLED 1
define HAL_MOUNT_ENABLED 1
define AP_MOUNT_BACKEND_DEFAULT_ENABLED 0
define HAL_MOUNT_SERVO_ENABLED 1

define DEFAULT_NTF_LED_TYPES 257

# enable logging to dataflash
define HAL_LOGGING_DATAFLASH_ENABLED 1
define HAL_LOGGING_DATAFLASH_DRIVER AP_Logger_Flash_JEDEC
define HAL_LOGGING_FLASH_JEDEC_ENABLED 1

define AP_BATTERY_ENABLED 1

#for smbus based batteries
undef AP_BATTERY_SMBUS_ENABLED
define AP_BATTERY_SMBUS_ENABLED 1

