# MCU class and specific type
MCU STM32H7xx STM32H743xx

# Board ID. See Tools/AP_Bootloader/board_types.txt
APJ_BOARD_ID AP_HW_3DRControlN1

# crystal frequency
OSCILLATOR_HZ 24000000
define STM32_HSE_BYPASS
define SMPS_EXT

FLASH_SIZE_KB 2048

# start on 2nd sector (1st sector for bootloader)
FLASH_RESERVE_START_KB 128

define HAL_STORAGE_SIZE 32768

# USB setup
USB_VENDOR 0x26ac
USB_PRODUCT 0x1186
USB_STRING_MANUFACTURER "3DR"
USB_STRING_PRODUCT "ControlN1"


# ## U(S)ART ports ##
# order of UARTs and suggested uses
# USART2 TELEM1 -w/flow control
# UART4 TELEM2 -w/flow control
# UART8 GPS    
# USART3 GPS2 
# USART6 additional
# UART7 additional
# USART1 additional 

SERIAL_ORDER OTG1 USART2 UART4 UART8 USART3 USART6 UART7 USART1

# USART2 TELEM1 -w/flow control
# SERIAL1_*
PD5 USART2_TX USART2
PD6 USART2_RX USART2
PD3 USART2_CTS USART2
PD4 USART2_RTS USART2

# USART4 TELEM2 -w/flow control
# SERIAL2_*
PD1 UART4_TX UART4
PD0 UART4_RX UART4
PB0 UART4_CTS UART4
PA15 UART4_RTS UART4

# UART8 GPS1
# SERIAL3_*
PE1 UART8_TX UART8
PE0 UART8_RX UART8

# USART3 GPS2
# SERIAL4_*
PD8 USART3_TX USART3
PD9 USART3_RX USART3

# USART6 ELRS (USER)
# SERIAL5_*
PC6 USART6_TX USART6
PC7 USART6_RX USART6

# UART7 -w/flow control (USER)
# SERIAL6_*
PE8 UART7_TX UART7
PE7 UART7_RX UART7
PE10 UART7_CTS UART7
PE9 UART7_RTS UART7

# USART1 (USER)
# SERIAL7_*
PA9 USART1_TX USART1
PA10 USART1_RX USART1

# ## I2C ##
PB8 I2C1_SCL I2C1
PB7 I2C1_SDA I2C1

PB10 I2C2_SCL I2C2
PB11 I2C2_SDA I2C2

# Order of I2C buses
I2C_ORDER I2C1 I2C2 

# I2C1 has the internal mag but is still exposed
define HAL_I2C_INTERNAL_MASK 0

# Battery Analog Sense Pins ADC1 CH 18 and 10, respectively
PA4 BATT_VOLTAGE_SENS ADC1 SCALE(1)
PC0 BATT_CURRENT_SENS ADC1 SCALE(1)

# VDD sense pin. This is used to sense primary board voltage. ADC_INP8
PC5 VDD_5V_SENS ADC1 SCALE(2)

# SPI1 IMU1 
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PD7 SPI1_MOSI SPI1

# SPI2 IMU2 
PB13 SPI2_SCK SPI2
PC2 SPI2_MISO SPI2
PC1 SPI2_MOSI SPI2

# SPI6 BARO DPS368 / F-RAM
PB3 SPI6_SCK SPI6
PB4 SPI6_MISO SPI6
PB5 SPI6_MOSI SPI6

# SPI4 External
# PE2 SPI4_SCK SPI4
# PE5 SPI4_MISO SPI4
# PE6 SPI4_MOSI SPI4

# USB HS as FS
PB14 OTG_HS_DM OTG1
PB15 OTG_HS_DP OTG1

env STM32_OTGHS_AS_OTG1 True

# Debug interface
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# PWM output for buzzer
PB9 TIM17_CH1 TIM17 GPIO(77) ALARM

# SDMMC 
PC8 SDMMC1_D0 SDMMC1
PC9 SDMMC1_D1 SDMMC1
PC10 SDMMC1_D2 SDMMC1
PC11 SDMMC1_D3 SDMMC1
PC12 SDMMC1_CK SDMMC1
PD2 SDMMC1_CMD SDMMC1

# CS pins for SPI sensors. 
# The labels for all CS pins need to match the SPI device table later in this file.
PE12 IMU1_CS CS
PE15 IMU2_CS CS
PE3  BARO_CS CS
PC13 FRAM_CS CS SPEED_VERYLOW NODMA
#PB2 EXTERNAL_CS CS

# CAN Buses (FDCAN 8Mbps)
PA12 CAN1_TX CAN1 
PA11 CAN1_RX CAN1

PB6 CAN2_TX CAN2
PB12 CAN2_RX CAN2

CAN_ORDER 1 2

# ## Motor outputs (PWM/DShot) ##
PA8 TIM1_CH1 TIM1 PWM(1) GPIO(50) BIDIR
PE11 TIM1_CH2 TIM1 PWM(2) GPIO(51)
PE13 TIM1_CH3 TIM1 PWM(3) GPIO(52) BIDIR
PE14 TIM1_CH4 TIM1 PWM(4) GPIO(53)

PA3 TIM2_CH4 TIM2 PWM(5) GPIO(54) BIDIR
PA2 TIM2_CH3 TIM2 PWM(6) GPIO(55)
PA1 TIM2_CH2 TIM2 PWM(7) GPIO(56) BIDIR 
PA0 TIM2_CH1 TIM2 PWM(8) GPIO(57)

PD12 TIM4_CH1 TIM4 PWM(9) GPIO(58) BIDIR
PD13 TIM4_CH2 TIM4 PWM(10) GPIO(59)
PD14 TIM4_CH3 TIM4 PWM(11) GPIO(60) BIDIR
PD15 TIM4_CH4 TIM4 PWM(12) GPIO(61)

# 13th pwm channel for addressable LED
PB1 TIM3_CH4 TIM3 PWM(13) 

define BOARD_PWM_COUNT_DEFAULT 13

# ## SPI ##
SPIDEV iim42653    SPI1 DEVID1  IMU1_CS      MODE3  4*MHZ  8*MHZ
SPIDEV iim42653_1    SPI2 DEVID1  IMU2_CS      MODE3  4*MHZ  8*MHZ
SPIDEV dps310      SPI6 DEVID1  BARO_CS      MODE3  5*MHZ  5*MHZ
SPIDEV ramtron     SPI6 DEVID10 FRAM_CS      MODE3  8*MHZ  8*MHZ

# Enable FAT filesystem support.
define HAL_OS_FATFS_IO 1
define HAL_WITH_RAMTRON 1

# 2 IMUs
IMU Invensensev3 SPI:iim42653 ROTATION_YAW_270
IMU Invensensev3 SPI:iim42653_1 ROTATION_YAW_270

define HAL_DEFAULT_INS_FAST_SAMPLE 7

# 1 baro
BARO DPS280      SPI:dps310

# 1 onboard compass
#COMPASS AK09940A:probe 0 ROTATION_ROLL_180_YAW270
define HAL_PROBE_EXTERNAL_I2C_COMPASSES

define HAL_BATT_MONITOR_DEFAULT 4
define HAL_BAT_VOLT_PIN 18
define HAL_BATT_CURR_PIN 10
define DEFAULT_NTF_LED_TYPES 257
