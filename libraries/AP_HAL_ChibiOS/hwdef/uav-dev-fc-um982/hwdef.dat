# hw definition for UAV-DEV GmbH FC-UM982

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# crystal frequency
OSCILLATOR_HZ 24000000

# board ID for firmware load
APJ_BOARD_ID AP_HW_UAV-DEV-FC-UM982-H7

FLASH_SIZE_KB 2048

# bootloader is installed at zero offset
FLASH_RESERVE_START_KB 128

# the location where the bootloader will put the firmware
# the H743 has 128k sectors
FLASH_BOOTLOADER_LOAD_KB 128

# LED
define HAL_LED_ON 1
PE9 LED_1 OUTPUT OPENDRAIN GPIO(0)
PE8 LED_2 OUTPUT OPENDRAIN GPIO(1)
PE7 LED_3 OUTPUT OPENDRAIN GPIO(2)

define AP_NOTIFY_GPIO_LED_3_ENABLED 1
define HAL_GPIO_A_LED_PIN 0
define HAL_GPIO_B_LED_PIN 1
define HAL_GPIO_C_LED_PIN 2

# PWM
PD12 TIM4_CH1 TIM4 PWM(1)  GPIO(50) BIDIR
PD13 TIM4_CH2 TIM4 PWM(2)  GPIO(51)
PD14 TIM4_CH3 TIM4 PWM(3)  GPIO(52) BIDIR
PD15 TIM4_CH4 TIM4 PWM(4)  GPIO(53)
PB0  TIM3_CH3 TIM3 PWM(5)  GPIO(54)
PB1  TIM3_CH4 TIM3 PWM(6)  GPIO(55)

# Enable FAT filesystem support (needs a microSD defined via SDMMC).
define HAL_OS_FATFS_IO 1

# supports upto 8 MBits/s
CANFD_SUPPORTED 8

STORAGE_FLASH_PAGE 14
define HAL_STORAGE_SIZE 32768

# ADC pins
PA0  VDD_5V_SENS ADC1 SCALE(2)

PE11 VDD_3V3_ETH_EN OUTPUT HIGH
PE10 VDD_3V3_GNSS_EN OUTPUT HIGH
PB10 NET_NRST OUTPUT HIGH
PD7 GNSS_NRST OUTPUT HIGH

PD4 GNSS_RTK_STAT INPUT
PD8 GNSS_PPS INPUT
PD10 GNSS_PVT_STAT INPUT
PD11 GNSS_EVENT INPUT

# RC INPUT USART6 is used for RCIN
# PA8 TIM1_CH1 TIM1 RCININT PULLDOWN

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1
PA9 VBUS INPUT OPENDRAIN

# CAN config
PD0 CAN1_RX CAN1
PD1 CAN1_TX CAN1
PE3 C1_SILENT OUTPUT LOW

PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2
PE4 C2_SILENT OUTPUT LOW

# SPI4
PE15 ICM_CS    CS
PD3  BARO_CS   CS
PE12 SPI4_SCK  SPI4
PE13 SPI4_MISO SPI4
PE14 SPI4_MOSI SPI4

# Sensors
SPIDEV icm45686 SPI4 DEVID1  ICM_CS      MODE3 2*MHZ  24*MHZ
SPIDEV dps310   SPI4 DEVID2  BARO_CS     MODE3 5*MHZ  5*MHZ

define HAL_DEFAULT_INS_FAST_SAMPLE 1
define HAL_INS_HIGHRES_SAMPLE 1
IMU Invensensev3 SPI:icm45686 ROTATION_NONE

BARO DPS310 SPI:dps310

define AP_COMPASS_PROBING_ENABLED 1
COMPASS BMM150 I2C:0:0x10 false ROTATION_ROLL_180

# I2C
PB9    I2C1_SDA I2C1
PB8    I2C1_SCL I2C1
I2C_ORDER I2C1

# Ethernet
PC1  ETH_MDC            ETH1
PA2  ETH_MDIO           ETH1
PC4  ETH_RMII_RXD0      ETH1
PC5  ETH_RMII_RXD1      ETH1
PB12 ETH_RMII_TXD0      ETH1
PB13 ETH_RMII_TXD1      ETH1
PB11 ETH_RMII_TX_EN     ETH1
PA7  ETH_RMII_CRS_DV    ETH1
PA1  ETH_RMII_REF_CLK   ETH1

define BOARD_PHY_ID  MII_LAN8742A_ID
define BOARD_PHY_RMII

# SDMMC
PC8    SDMMC1_D0    SDMMC1
PC9    SDMMC1_D1    SDMMC1
PC10   SDMMC1_D2    SDMMC1
PC11   SDMMC1_D3    SDMMC1
PC12   SDMMC1_CK    SDMMC1
PD2    SDMMC1_CMD   SDMMC1

# SWD
PA13    JTMS-SWDIO    SWD
PA14    JTCK-SWCLK    SWD

# UART

# SERIAL1
PB14 USART1_TX USART1
PB15 USART1_RX USART1

# SERIAL3
PD5  USART2_TX USART2
PD6  USART2_RX USART2
define DEFAULT_SERIAL3_PROTOCOL SerialProtocol_Scripting

# SERIAL6
PD9  USART3_RX USART3
define DEFAULT_SERIAL6_PROTOCOL SerialProtocol_ESCTelemetry

# SERIAL4
PC6  USART6_TX USART6
PC7  USART6_RX USART6
define DEFAULT_SERIAL4_PROTOCOL SerialProtocol_RCIN

# SERIAL5
PB3  UART7_RX UART7
PB4  UART7_TX UART7
define DEFAULT_SERIAL5_PROTOCOL SerialProtocol_MAVLink2

# SERIAL2
PE0  UART8_RX UART8
PE1  UART8_TX UART8
define DEFAULT_SERIAL2_PROTOCOL SerialProtocol_GPS

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1 UART8 USART2 USART6 UART7 USART3 OTG2

define AP_NETWORKING_DEFAULT_STATIC_IP_ADDR "192.168.144.15"
define AP_NETWORKING_DEFAULT_STATIC_GW_ADDR "192.168.144.10"

# build ABIN for flash-from-bootloader support:
env BUILD_ABIN True
