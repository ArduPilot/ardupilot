"""
Waf tool for functions common to the esp32, Linux and ChibiOS builds.

AP_FLAKE8_CLEAN
"""


def load_env_vars(env, hwdef_env, kv_handler=None):
    '''load environment variables from the hwdef generator'''
    for kv in hwdef_env.items():
        if kv_handler is not None:
            kv_handler(env, kv)
            continue
        load_env_vars_handle_kv_pair(env, kv)


def load_env_vars_handle_kv_pair(env, kv_pair):
    '''handle a key/value pair out of the hwdef generator'''
    (k, v) = kv_pair
    if k in env:
        if isinstance(env[k], dict):
            a = v.split('=')
            env[k][a[0]] = '='.join(a[1:])
            print("env updated %s=%s" % (k, v))
        elif isinstance(env[k], list):
            env[k].append(v)
            print("env appended %s=%s" % (k, v))
        else:
            env[k] = v
            print("env added %s=%s" % (k, v))
    else:
        env[k] = v
        print("env set %s=%s" % (k, v))


def handle_hwdef_files(cfg, hwdef_files):
    # note files generated by hwdef system as cfg_files. this ensures they
    # don't get deleted on `./waf clean`. this also ensures their node exists
    # so implicit dependencies are properly tracked.

    bldnode = cfg.bldnode.make_node(cfg.variant)
    for file in sorted(hwdef_files):
        cfg.env.append_value("cfg_files", bldnode.make_node(file).abspath())
